<!-- Welcome / Login Overlay -->
<div id="welcomeOverlay">
  <div class="welcomeCard">
    <h3>Welcome to Talk 2Me Nice</h3>
    <p>Enter a nickname and choose your companion to start chatting.</p>
    
    <input id="nicknameOverlay" placeholder="Enter your nickname" />

    <div id="companionSelectorOverlay">
      <h4>Choose Your Companion</h4>
      <div class="companionGrid">
        <div class="companionCardOverlay" data-companion="Whisp">
          <h5>Whisp</h5>
          <p>Gentle, supportive, calm</p>
          <small>‚ÄúI‚Äôm here with you. Take your time.‚Äù</small>
        </div>
        <div class="companionCardOverlay" data-companion="Ace">
          <h5>Ace</h5>
          <p>Confident, playful, witty</p>
          <small>‚ÄúYou‚Äôve got my attention ‚Äî what‚Äôs on your mind?‚Äù</small>
        </div>
        <div class="companionCardOverlay" data-companion="Sage">
          <h5>Sage</h5>
          <p>Thoughtful, clear, insightful</p>
          <small>‚ÄúLet‚Äôs think this through carefully.‚Äù</small>
        </div>
        <div class="companionCardOverlay" data-companion="School">
          <h5>School Mode</h5>
          <p>Polite, age-appropriate, educational</p>
          <small>‚ÄúHow can I help you learn today?‚Äù</small>
        </div>
      </div>
    </div>

    <div id="landingOptions">
      <label>
        Language: 
        <select id="languageSelect">
          <option value="en-US" selected>English</option>
          <option value="es-ES">Spanish</option>
          <option value="fr-FR">French</option>
          <option value="de-DE">German</option>
        </select>
      </label>
      <label>
        <input type="checkbox" id="dummyModeToggle"> Dummy Mode (Test)
      </label>
    </div>

    <button id="startChatBtn">Start Chat</button>
  </div>
</div>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Talk 2Me Nice</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
<style>
:root {
  --bg-main: linear-gradient(160deg, #1b1f27 0%, #2a2f3b 100%);
  --bg-card: #2c313d;
  --accent: #ffb86c;
  --text-main: #e1e4ea;
  --text-muted: #a1a6b0;
  /* Sticky footer adjustments */
#chatContainer {
  flex: 1 1 auto;
  display: flex;
  gap: 1rem;
  animation: fadeIn 0.8s ease-out;
  min-height: calc(100vh - 80px); /* leave space for footer */
}
footer {
  position: sticky;
  bottom: 0;
  display: flex;
  padding: 0.8rem;
  gap: 0.5rem;
  background: var(--bg-card);
  z-index: 10;
  align-items: center;
}

/* Privacy & Support links at bottom of sidebar */
#sidebarLinks {
  margin-top: auto;
  font-size: 0.8rem;
  text-align: center;
}
#sidebarLinks a {
  color: var(--text-muted);
  text-decoration: none;
  margin: 0 0.4rem;
}
#sidebarLinks a:hover {
  text-decoration: underline;
  color: var(--accent);
}

/* Basic layout */
body { margin:0; font-family:'Montserrat',system-ui,sans-serif; background: var(--bg-main); color: var(--text-main); display:flex; flex-direction:column; min-height:100vh; }
h3,h4 { font-family:'Playfair Display', serif; }
button { font-family:'Montserrat', sans-serif; }

#landingPage, #chatContainer { max-width:900px; margin:2rem auto; display:flex; flex-direction:column; gap:1rem; }

input, select { font-family:'Montserrat', sans-serif; }

.hidden { display:none; }

/* Landing page */
#landingPage input { padding:0.6rem; border-radius:12px; border:none; background:#1f232d; color:var(--text-main); margin-bottom:1rem; width:100%; }
#landingPage button { padding:0.6rem 1rem; border-radius:999px; border:none; background: var(--accent); cursor:pointer; transition: all 0.3s ease; width:100%; }
#landingPage button:hover { transform: scale(1.05); background:#ff9f40; }

/* Companion selector */
#companionSelector h3 { text-align:center; color:var(--accent); margin-bottom:1rem; }
.companionGrid { display:grid; grid-template-columns:repeat(auto-fit, minmax(140px,1fr)); gap:1rem; }
.companionCard { background: var(--bg-card); border-radius: 14px; padding: 1rem; cursor:pointer; text-align:center; transition: all 0.25s ease; border: 2px solid transparent; }
.companionCard h4 { margin:0; }
.companionCard p { font-size:0.85rem; color:var(--text-muted); margin-top:0.4rem; }
.companionCard small.preview { display:block; margin-top:0.5rem; font-size:0.75rem; color:var(--text-muted); font-style:italic; }
.companionCard:hover { transform: translateY(-4px); box-shadow:0 8px 18px rgba(0,0,0,0.35);}
.companionCard.active { border-color:var(--accent); box-shadow:0 0 0 2px rgba(255,184,108,0.25); }

/* Chat container */
#chatContainer { flex-direction:row; display:flex; gap:1rem; animation:fadeIn 0.8s ease-out; }
#profileSidebar { width:220px; padding:1rem; background: var(--bg-card); border-radius:16px; flex-shrink:0; display:flex; flex-direction:column; gap:1rem; box-shadow:0 6px 16px rgba(0,0,0,0.3);}
#starterBox { margin:1rem 0; padding:0.8rem; background:#1f232d; border-radius:12px; cursor:pointer; transition: transform 0.2s; }
#starterBox:hover { transform:scale(1.03); }
#starterTitle { font-weight:600; margin:0.5rem 0; color:#ffb86c; text-align:center; }
#chatArea { flex:1; display:flex; flex-direction:column; background: var(--bg-card); border-radius:16px; padding:1rem; box-shadow:0 6px 16px rgba(0,0,0,0.25); }
.message { max-width:75%; padding:0.8rem 1.2rem; margin-bottom:0.7rem; border-radius:20px; line-height:1.5; opacity:0; animation:fadeInMessage 0.5s forwards; }
.user { background:var(--accent); color:#1b1f27; align-self:flex-end; }
.bot { background:var(--bg-card); align-self:flex-start; }

footer { display:flex; padding:0.8rem; gap:0.5rem; }
footer input { flex:1; padding:0.6rem; border-radius:12px; border:none; background:#1f232d; color:var(--text-main); }
footer button { padding:0.6rem 1rem; border-radius:999px; border:none; background: var(--accent); cursor:pointer; transition: all 0.3s ease; }
footer button:hover { transform: scale(1.05); background:#ff9f40; }

#micBtn { border-radius:50%; width:42px; height:42px; font-size:1.2rem; background: var(--accent); border:none; cursor:pointer; }
#micBtn.listening { animation:pulse 1.2s infinite; }
#micBtn.disabled { opacity:0.4; cursor:not-allowed; }

@keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
@keyframes fadeInMessage { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
@keyframes pulse {0%{box-shadow:0 0 0 0 rgba(255,184,108,0.6);} 70%{box-shadow:0 0 0 12px rgba(255,184,108,0);} 100%{box-shadow:0 0 0 0 rgba(255,184,108,0);}}
#voiceSettings { background: var(--bg-card); padding:1rem; border-radius:14px; margin-top:1rem; font-size:0.85rem;}
#voiceSettings h4 { margin-top:0; color:var(--accent);}
#voiceSettings label { display:flex; align-items:center; justify-content:space-between; margin-bottom:0.6rem; gap:0.5rem;}

/* Onboarding */
#onboarding {position:fixed; inset:0; background: rgba(0,0,0,0.65); display:flex; align-items:center; justify-content:center; z-index:999;}
.onboardCard {background: var(--bg-card); padding:2rem; border-radius:18px; max-width:360px; text-align:center;}
.onboardCard h3 {color:var(--accent);}
.onboardCard button {margin-top:1rem; padding:0.6rem 1.4rem; border-radius:999px; border:none; background: var(--accent); cursor:pointer;}
</style>
</head>
<body>

<!-- Landing Page -->
<div id="landingPage">
  <input id="nicknameInput" placeholder="Enter your nickname" />
  <div id="companionSelector">
    <h3>Choose Your Companion</h3>
    <div class="companionGrid">
      <div class="companionCard" data-companion="Whisp"><h4>Whisp</h4><p>Gentle, supportive, calm</p><small class="preview">‚ÄúI‚Äôm here with you. Take your time.‚Äù</small></div>
      <div class="companionCard" data-companion="Ace"><h4>Ace</h4><p>Confident, playful, witty</p><small class="preview">‚ÄúYou‚Äôve got my attention ‚Äî what‚Äôs on your mind?‚Äù</small></div>
      <div class="companionCard" data-companion="Sage"><h4>Sage</h4><p>Thoughtful, clear, insightful</p><small class="preview">‚ÄúLet‚Äôs think this through carefully.‚Äù</small></div>
      <div class="companionCard" data-companion="School"><h4>School Mode</h4><p>Polite, age-appropriate, educational</p><small class="preview">‚ÄúHow can I help you learn today?‚Äù</small></div>
    </div>
  </div>
  <button onclick="startChat()">Start Chat</button>
</div>

<!-- Chat Container -->
<div id="chatContainer" class="hidden">
  <div id="profileSidebar">
    <div class="profileInfo">
      <p>üë§ <strong id="profileName"></strong></p>
      <p>üåç <span id="profileLanguage"></span></p>
      <p>üßö <span id="profileCompanion"></span></p>
      <div id="sidebarLinks">
  <a href="#">Privacy</a> | <a href="#">Support</a>
    </div>
    <hr>
    <p id="starterTitle">Conversation Starters</p>
    <select id="starterDropdown" onchange="startStarter()">
      <option value="">-- Select Starter --</option>
    </select>
    <div id="voiceSettings">
      <h4>Voice Settings</h4>
      <label><input type="checkbox" id="voiceOutputToggle" checked> Voice replies</label>
      <label><input type="checkbox" id="voiceInputToggle" checked> Voice input</label>
      <label>Speech speed
        <select id="voiceSpeed">
          <option value="0.9">Slow</option>
          <option value="1" selected>Normal</option>
          <option value="1.1">Fast</option>
        </select>
      </label>
    </div>
  </div>

  <div id="chatArea">
    <div id="chat"></div>
  </div>
</div>

<footer class="hidden">
  <input id="userInput" placeholder="Type a message‚Ä¶" />
  <button id="micBtn" onclick="startSpeechToSpeech()">üé§</button>
  <button onclick="sendMessage()">Send</button>
  <button id="speechToSpeechBtn" class="active" onclick="toggleSpeechToSpeech()">üó£Ô∏è Speech-to-Speech: ON</button>
</footer>

<!-- Onboarding Overlay -->
<div id="onboarding" class="hidden">
  <div class="onboardCard">
    <h3>Welcome to Talk 2Me Nice</h3>
    <p>Your companion can speak and listen.</p>
    <p>You can change companions or voice settings anytime.</p>
    <button onclick="finishOnboarding()">Let‚Äôs go</button>
  </div>
</div>

<script>
// ----------- Companion Definitions -----------
const companions = {
  Whisp: { name:"Whisp", description:"Gentle, supportive, calm", voice:{input:true, output:true, speakingStyle:"soft"}, systemPrompt:`You are Whisp, a gentle and supportive companion. Speak warmly and calmly.` },
  Ace: { name:"Ace", description:"Confident, playful, witty", voice:{input:true, output:true, speakingStyle:"energetic"}, systemPrompt:`You are Ace, confident and playful. Speak upbeat and engaging.` },
  Sage: { name:"Sage", description:"Thoughtful, clear, insightful", voice:{input:true, output:true, speakingStyle:"neutral"}, systemPrompt:`You are Sage, thoughtful and articulate. Speak clearly and professionally.` },
  School: { name:"School Mode", description:"Polite, age-appropriate, educational", voice:{input:false, output:true, speakingStyle:"clear"}, systemPrompt:`You are a school-safe conversational assistant. Use age-appropriate language.` }
};

// ----------- Landing Page & Companion Selection -----------
const companionCards = document.querySelectorAll(".companionCard");
const nicknameInput = document.getElementById("nicknameInput");

function loadCompanionSelection() {
  const saved = localStorage.getItem("companion") || "Whisp";
  setActiveCompanion(saved);
}
function setActiveCompanion(id){
  companionCards.forEach(card=>card.classList.remove("active"));
  document.querySelector(`.companionCard[data-companion='${id}']`)?.classList.add("active");
  localStorage.setItem("companion",id);
  applyVoiceRules();
}
companionCards.forEach(card=>card.addEventListener("click",()=>setActiveCompanion(card.dataset.companion)));
loadCompanionSelection();

function startChat(){
  if(!nicknameInput.value.trim()) { alert("Enter a nickname"); return; }
  localStorage.setItem("nickname",nicknameInput.value.trim());
  document.getElementById("landingPage").classList.add("hidden");
  document.getElementById("chatContainer").classList.remove("hidden");
  document.querySelector("footer").classList.remove("hidden");
  document.getElementById("profileName").textContent = nicknameInput.value.trim();
  document.getElementById("profileLanguage").textContent = localStorage.getItem("language") || "en-US";
  document.getElementById("profileCompanion").textContent = localStorage.getItem("companion") || "Whisp";
  populateStarters();
  applyVoiceRules();
  checkOnboarding();
}

// ----------- Conversation Starters -----------
const conversationStarters = {
  "Workplace":[`Good morning! How's your day starting?`,`Hi! Did you catch the latest project update?`,`Evening! Ready to wrap things up?`],
  "Dating & Social":[`Hi there! Would you like to grab coffee?`,`Hey! Want to take a walk this afternoon?`,`Hello! How was your day today?`],
  "Travel":[`Hi! Where is the nearest train station?`],
  "School":[`Hello! How was class today?`,`Do you need help with homework?`],
  "Advanced Small Talk":[`Hello! Did you see the game yesterday?`]
};
function populateStarters(){
  const dd = document.getElementById("starterDropdown");
  dd.innerHTML = `<option value="">-- Select Starter --</option>`;
  Object.keys(conversationStarters).forEach(cat=>{
    conversationStarters[cat].forEach(phrase=>{
      const opt = document.createElement("option");
      opt.value = phrase; opt.textContent = `${cat}: ${phrase}`;
      dd.appendChild(opt);
    });
  });
}
function startStarter(){
  const val = document.getElementById("starterDropdown").value;
  if(val) sendMessage(val);
}

// ----------- Voice Settings -----------
const voiceDefaults = {output:true,input:true,speed:1};
const voiceOutputToggle = document.getElementById("voiceOutputToggle");
const voiceInputToggle = document.getElementById("voiceInputToggle");
const voiceSpeed = document.getElementById("voiceSpeed");

function loadVoiceSettings(){
  const saved = JSON.parse(localStorage.getItem("voiceSettings")) || voiceDefaults;
  voiceOutputToggle.checked = saved.output;
  voiceInputToggle.checked = saved.input;
  voiceSpeed.value = saved.speed;
}
function saveVoiceSettings(){
  localStorage.setItem("voiceSettings",JSON.stringify({output:voiceOutputToggle.checked,input:voiceInputToggle.checked,speed:voiceSpeed.value}));
  applyVoiceRules();
}
voiceOutputToggle.onchange=voiceInputToggle.onchange=voiceSpeed.onchange=saveVoiceSettings;
loadVoiceSettings();

// ----------- Voice Rules & Mic -----------
const micBtn = document.getElementById("micBtn");
let windowVoiceOutputAllowed=true;
let windowVoiceSpeed=1;

function applyVoiceRules(){
  const companionId = localStorage.getItem("companion") || "Whisp";
  const companion = companions[companionId];
  const settings = JSON.parse(localStorage.getItem("voiceSettings")) || voiceDefaults;
  micBtn.disabled = !companion.voice.input || !settings.input;
  windowVoiceOutputAllowed = companion.voice.output && settings.output;
  windowVoiceSpeed = settings.speed;
}

function speakBotText(text){
  if(!windowVoiceOutputAllowed) return;
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = localStorage.getItem("language") || "en-US";
  utter.rate = windowVoiceSpeed;
  speechSynthesis.speak(utter);
}

// ----------- Speech-to-Speech Mode -----------
let speechMode=true;
const speechBtn = document.getElementById("speechToSpeechBtn");
function toggleSpeechToSpeech(){
  speechMode=!speechMode;
  speechBtn.classList.toggle("active",speechMode);
  speechBtn.textContent=`üó£Ô∏è Speech-to-Speech: ${speechMode ? 'ON':'OFF'}`;
}

function startSpeechToSpeech(){
  if(!speechMode || micBtn.disabled) return;
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = localStorage.getItem("language") || "en-US";
  recognition.interimResults=false; recognition.continuous=false;
  micBtn.classList.add("listening");

  recognition.onresult=async (event)=>{
    const spoken = event.results[0][0].transcript;
    sendMessage(spoken);
  };
  recognition.onend=()=>{ micBtn.classList.remove("listening"); if(speechMode) setTimeout(()=>recognition.start(),300);}
  recognition.start();
}

// ----------- Chat Handling / Typing -----------
const chat = document.getElementById("chat");

function addMessage(text,sender){
  const div=document.createElement("div");
  div.className=`message ${sender}`;
  div.textContent=text;
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
}

function showTyping(text){
  let i=0;
  const div=document.createElement("div");
  div.className="message bot";
  chat.appendChild(div);
  function type(){ 
    if(i<text.length){ div.textContent+=text[i]; i++; setTimeout(type,20);} 
    else {speakBotText(text); chat.scrollTop=chat.scrollHeight; } 
  }
  type();
}

// ----------- AI Call Placeholder -----------
async function translateText(text,toLang){ 
  // Replace with translation API if needed
  return text; 
} 

async function getAIResponse(userText, companionPrompt){ 
  // Replace with OpenAI API call
  // Example:
  /*
  const res = await fetch("https://api.openai.com/v1/chat/completions", {
    method:"POST",
    headers:{ "Content-Type":"application/json", "Authorization":"Bearer YOUR_KEY" },
    body: JSON.stringify({ model:"gpt-4", messages:[{role:"system",content:companionPrompt},{role:"user",content:userText}], temperature:0.7 })
  });
  const data = await res.json();
  return data.choices[0].message.content;
  */
  return `Echo (${companions[localStorage.getItem("companion")].name}): ${userText}`;
}

// ----------- Send Message -----------
async function sendMessage(msg=null){
  const input=document.getElementById("userInput");
  const text = msg || input.value.trim();
  if(!text) return;
  addMessage(text,"user");
  input.value="";

  const companionId = localStorage.getItem("companion") || "Whisp";
  const companion = companions[companionId];

  // Translate to English if needed
  const englishText = await translateText(text,"en");

  // AI response
  const aiResponse = await getAIResponse(englishText, companion.systemPrompt);

  // Translate back to user language
  const finalText = await translateText(aiResponse, localStorage.getItem("language") || "en-US");

  showTyping(finalText);
}

// ----------- Onboarding -----------
function checkOnboarding(){
  if(!localStorage.getItem("onboardComplete")){
    document.getElementById("onboarding").classList.remove("hidden");
  }
}
function finishOnboarding(){
  localStorage.setItem("onboardComplete",true);
  document.getElementById("onboarding").classList.add("hidden");
}

// ----------- Optional: Press Enter to send message -----------
document.getElementById("userInput").addEventListener("keypress",(e)=>{
  if(e.key==="Enter") sendMessage();
});
</script>

// ----------- Landing Page & Companion Selection -----------
const companionCards = document.querySelectorAll(".companionCard");
const nicknameInput = document.getElementById("nicknameInput");

function loadCompanionSelection() {
  const saved = localStorage.getItem("companion") || "Whisp";
  setActiveCompanion(saved);
}
function setActiveCompanion(id){
  companionCards.forEach(card=>card.classList.remove("active"));
  document.querySelector(`.companionCard[data-companion='${id}']`)?.classList.add("active");
  localStorage.setItem("companion",id);
  applyVoiceRules();
}
companionCards.forEach(card=>card.addEventListener("click",()=>setActiveCompanion(card.dataset.companion)));
loadCompanionSelection();

function startChat(){
  if(!nicknameInput.value.trim()) { alert("Enter a nickname"); return; }
  localStorage.setItem("nickname",nicknameInput.value.trim());
  document.getElementById("landingPage").classList.add("hidden");
  document.getElementById("chatContainer").classList.remove("hidden");
  document.querySelector("footer").classList.remove("hidden");
  document.getElementById("profileName").textContent = nicknameInput.value.trim();
  document.getElementById("profileLanguage").textContent = localStorage.getItem("language") || "en-US";
  document.getElementById("profileCompanion").textContent = localStorage.getItem("companion") || "Whisp";
  populateStarters();
  applyVoiceRules();
  checkOnboarding();
}

// ----------- Conversation Starters -----------
const conversationStarters = {
  "Workplace":[`Good morning! How's your day starting?`,`Hi! Did you catch the latest project update?`,`Evening! Ready to wrap things up?`],
  "Dating & Social":[`Hi there! Would you like to grab coffee?`,`Hey! Want to take a walk this afternoon?`,`Hello! How was your day today?`],
  "Travel":[`Hi! Where is the nearest train station?`],
  "School":[`Hello! How was class today?`,`Do you need help with homework?`],
  "Advanced Small Talk":[`Hello! Did you see the game yesterday?`]
};
function populateStarters(){
  const dd = document.getElementById("starterDropdown");
  dd.innerHTML = `<option value="">-- Select Starter --</option>`;
  Object.keys(conversationStarters).forEach(cat=>{
    conversationStarters[cat].forEach(phrase=>{
      const opt = document.createElement("option");
      opt.value = phrase; opt.textContent = `${cat}: ${phrase}`;
      dd.appendChild(opt);
    });
  });
}
function startStarter(){
  const val = document.getElementById("starterDropdown").value;
  if(val) sendMessage(val);
}

// ----------- Voice Settings -----------
const voiceDefaults = {output:true,input:true,speed:1};
const voiceOutputToggle = document.getElementById("voiceOutputToggle");
const voiceInputToggle = document.getElementById("voiceInputToggle");
const voiceSpeed = document.getElementById("voiceSpeed");
function loadVoiceSettings(){
  const saved = JSON.parse(localStorage.getItem("voiceSettings")) || voiceDefaults;
  voiceOutputToggle.checked = saved.output;
  voiceInputToggle.checked = saved.input;
  voiceSpeed.value = saved.speed;
}
function saveVoiceSettings(){
  localStorage.setItem("voiceSettings",JSON.stringify({output:voiceOutputToggle.checked,input:voiceInputToggle.checked,speed:voiceSpeed.value}));
  applyVoiceRules();
}
voiceOutputToggle.onchange=voiceInputToggle.onchange=voiceSpeed.onchange=saveVoiceSettings;
loadVoiceSettings();

// ----------- Voice Rules & Mic -----------
const micBtn = document.getElementById("micBtn");
let windowVoiceOutputAllowed=true;
let windowVoiceSpeed=1;

function applyVoiceRules(){
  const companionId = localStorage.getItem("companion") || "Whisp";
  const companion = companions[companionId];
  const settings = JSON.parse(localStorage.getItem("voiceSettings")) || voiceDefaults;
  micBtn.disabled = !companion.voice.input || !settings.input;
  windowVoiceOutputAllowed = companion.voice.output && settings.output;
  windowVoiceSpeed = settings.speed;
}

function speakBotText(text){
  if(!windowVoiceOutputAllowed) return;
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = localStorage.getItem("language") || "en-US";
  utter.rate = windowVoiceSpeed;
  speechSynthesis.speak(utter);
}

// ----------- Speech-to-Speech Mode -----------
let speechMode=true;
const speechBtn = document.getElementById("speechToSpeechBtn");
function toggleSpeechToSpeech(){
  speechMode=!speechMode;
  speechBtn.classList.toggle("active",speechMode);
  speechBtn.textContent=`üó£Ô∏è Speech-to-Speech: ${speechMode ? 'ON':'OFF'}`;
}

function startSpeechToSpeech(){
  if(!speechMode || micBtn.disabled) return;
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = localStorage.getItem("language") || "en-US";
  recognition.interimResults=false; recognition.continuous=false;
  micBtn.classList.add("listening");

  recognition.onresult=async (event)=>{
    const spoken = event.results[0][0].transcript;
    sendMessage(spoken);
  };
  recognition.onend=()=>{ micBtn.classList.remove("listening"); if(speechMode) setTimeout(()=>recognition.start(),300);}
  recognition.start();
}

// ----------- Chat Handling / Typing -----------
const chat = document.getElementById("chat");
function addMessage(text,sender){
  const div=document.createElement("div");
  div.className=`message ${sender}`;
  div.textContent=text;
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
}
function showTyping(text){
  let i=0;
  const div=document.createElement("div");
  div.className="message bot";
  chat.appendChild(div);
  function type(){ if(i<text.length){ div.textContent+=text[i]; i++; setTimeout(type,20);} else {speakBotText(text); chat.scrollTop=chat.scrollHeight; } }
  type();
}

// ----------- AI Call Placeholder -----------
async function translateText(text,toLang){ return text; } // Replace with real translation API if desired
async function getAIResponse(userTextEnglish){ return `Echo: ${userTextEnglish}`; } // Replace with OpenAI API call

async function sendMessage(msg=null){
  const input=document.getElementById("userInput");
  const
async function sendMessage(msg=null){
  const input=document.getElementById("userInput");
  const text = msg || input.value.trim();
  if(!text) return;
  addMessage(text,"user");
  input.value="";

  // AI processing
  const companionId = localStorage.getItem("companion") || "Whisp";
  const companion = companions[companionId];

  // Translate to English if needed
  const englishText = await translateText(text,"en");

  // AI response
  const aiResponse = await getAIResponse(englishText, companion.systemPrompt);

  // Translate back
  const finalText = await translateText(aiResponse, localStorage.getItem("language") || "en-US");

  // Show typing
  showTyping(finalText);
}
async function getAIResponse(userText, companionPrompt){
  const body = {
    model: "gpt-4",
    messages: [
      { role: "system", content: companionPrompt },
      { role: "user", content: userText }
    ],
    temperature: 0.7
  };
  const res = await fetch("https://api.openai.com/v1/chat/completions", {
    method:"POST",
    headers:{ "Content-Type":"application/json", "Authorization":"Bearer YOUR_OPENAI_API_KEY" },
    body: JSON.stringify(body)
  });

  const data = await res.json();
  return data.choices[0].message.content;
}
